name: "[Template] Build and distribute custom VM image"
description: |
  This workflow builds and distributes a custom VM image using the Azure Image Builder service.
  It uses a template to create a shared image gallery image and distribute it across regions.

on:
  workflow_call:
    inputs:
      templateFolder: { required: true, type: string }
      templateName: { required: true, type: string }
      sigResourceGroup: { required: true, type: string }
      imageDefName: { required: true, type: string }
      sigName: { required: true, type: string }
      location: { required: true, type: string }
      additionalregion: { required: true, type: string }
      runOutputName: { required: true, type: string }
    secrets:
      AZURE_CLIENT_ID: { required: true }
      AZURE_TENANT_ID: { required: true }
      AZURE_SUBSCRIPTION_ID: { required: true }

permissions:
  contents: write
  id-token: write
  actions: read
  security-events: write

concurrency:
  group: "semverbot-release-${{ github.ref_name }}"
  cancel-in-progress: false

env:
  SEMVERBOT_VERSION: "1.7.2"

jobs:
  BUILD-CUSTOM-IMAGE:
    runs-on: ubuntu-latest
    outputs:
      release_version: ${{ steps.set_version.outputs.release_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Login with Azure OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install semverbot
        id: install_semverbot
        shell: bash -euo pipefail
        run: |
          mkdir -p "$HOME/bin"
          echo "$HOME/bin" >> "$GITHUB_PATH"
          curl -sL -o "$HOME/bin/sbot" \
            "https://github.com/restechnica/semverbot/releases/download/v${SEMVERBOT_VERSION}/sbot-linux-amd64"
          chmod +x "$HOME/bin/sbot"

      - name: Compute version bump
        id: set_version
        shell: bash -euo pipefail
        run: |
          sbot update version
          current=$(sbot get version)
          next=$(sbot predict version)

          echo "Current version: $current"
          echo "Next version:    $next"

          echo "CURRENT_VERSION=$current" >> "$GITHUB_ENV"
          echo "RELEASE_VERSION=$next"   >> "$GITHUB_ENV"
          echo "release_version=$next"   >> "$GITHUB_OUTPUT"

      - name: Download and configure image template
        shell: bash -euo pipefail
        env:
          subscriptionID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          sigResourceGroup: ${{ inputs.sigResourceGroup }}
          imageDefName: ${{ inputs.imageDefName }}
          sigName: ${{ inputs.sigName }}
          location: ${{ inputs.location }}
          additionalregion: ${{ inputs.additionalregion }}
          runOutputName: ${{ inputs.runOutputName }}
          imgBuilderId: "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ inputs.sigResourceGroup }}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/rai-identity"
        run: |
          cp templates/${{ inputs.templateFolder }}/${{ inputs.templateName }} ${{ inputs.templateName }}

          sed -i -e "s|<subscriptionID>|$subscriptionID|g"            ${{ inputs.templateName }}
          sed -i -e "s|<rgName>|$sigResourceGroup|g"                  ${{ inputs.templateName }}
          sed -i -e "s|<imageDefName>|$imageDefName|g"               ${{ inputs.templateName }}
          sed -i -e "s|<sharedImageGalName>|$sigName|g"              ${{ inputs.templateName }}
          sed -i -e "s|<region1>|$location|g"                        ${{ inputs.templateName }}
          sed -i -e "s|<region2>|$additionalregion|g"                ${{ inputs.templateName }}
          sed -i -e "s|<runOutputName>|$runOutputName|g"             ${{ inputs.templateName }}
          sed -i -e "s%<imgBuilderId>%$imgBuilderId%g"               ${{ inputs.templateName }}

      - name: Build and distribute custom VM image
        shell: bash -euo pipefail
        env:
          subscriptionID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          sigResourceGroup: ${{ inputs.sigResourceGroup }}
          imageDefName: ${{ inputs.imageDefName }}
          sigName: ${{ inputs.sigName }}
          location: ${{ inputs.location }}
          additionalregion: ${{ inputs.additionalregion }}
          runOutputName: ${{ inputs.runOutputName }}
          imgBuilderId: "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ inputs.sigResourceGroup }}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/rai-identity"
        run: |
          IMAGE_TEMPLATE_NAME="${{ inputs.templateName }}-${RELEASE_VERSION}"

          az resource create \
            --resource-group $sigResourceGroup \
            --properties @${{ inputs.templateName }} \
            --is-full-object \
            --resource-type Microsoft.VirtualMachineImages/imageTemplates \
            -n "$IMAGE_TEMPLATE_NAME"

          az resource invoke-action \
            --resource-group $sigResourceGroup \
            --resource-type Microsoft.VirtualMachineImages/imageTemplates \
            -n "$IMAGE_TEMPLATE_NAME" \
            --action Run

      - name: Release and push version tag
        if: github.ref == 'refs/heads/main'
        shell: bash -euo pipefail
        run: |
          sbot release version
          sbot push version
