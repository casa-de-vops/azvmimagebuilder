name: Validate and Cleanup

description: |
  Reusable step template for validating a custom VM image and cleaning up resources.

inputs:
  sig-resource-group:
    required: true
    type: string
  template-type:
    required: true
    type: string
  image-template-name:
    required: true
    type: string
  primary-region:
    required: true
    type: string
  subscription-id:
    required: true
    type: string
  sig-name:
    required: true
    type: string
  image-def-name:
    required: true
    type: string
  validation-vm-name:
    required: true
    type: string
  validation-rg:
    required: true
    type: string

runs:
  using: composite
  steps:
    # ── Wait for image distribution to complete ──────────────────
    - name: Wait for image distribution to complete
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        Write-Host "Waiting for image distribution to complete..."

        # Wait for the image distribution to finish (checking template status)
        $maxRetries = 60  # 30 minutes (checking every 30 seconds)
        $retryCount = 0
        $success = $false

        do {
          $retryCount++
          $res = Get-AzResource `
            -ResourceGroupName ${{ inputs.sig-resource-group }} `
            -ResourceType 'Microsoft.VirtualMachineImages/imageTemplates' `
            -Name ${{ inputs.image-template-name }} `
            -ErrorAction SilentlyContinue
          
          if ($res -and $res.Properties.lastRunStatus) {
            $status = $res.Properties.lastRunStatus
            Write-Host "[$retryCount/$maxRetries] Image status: $($status.runState) → $($status.runSubState)"
            
            if ($status.runState -eq 'Succeeded') {
              $success = $true
              break
            }
            elseif ($status.runState -eq 'Failed' -or $status.runState -eq 'Canceled') {
              Write-Host "Image creation failed with status: $($status.runState)"
              Write-Host "Error: $($status.message)"
              exit 1
            }
          }
          else {
            Write-Host "[$retryCount/$maxRetries] Waiting for image template status..."
          }
          
          Start-Sleep -Seconds 30
        } while ($retryCount -lt $maxRetries)

        if (-not $success) {
          Write-Host "Timed out waiting for image distribution to complete!"
          exit 1
        }

        Write-Host "Image distribution completed successfully!"

    # ── Create resource group for validation VM ─────────────────
    - name: Create validation resource group
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        New-AzResourceGroup -Name ${{ inputs.validation-rg }} -Location ${{ inputs.primary-region }} -Force
        Write-Host "Created validation resource group: ${{ inputs.validation-rg }}"

    # ── Deploy validation VM using the new image ────────────────
    - name: Deploy validation VM
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        
        # Get the latest image version
        $imageId = (Get-AzGalleryImageVersion -ResourceGroupName ${{ inputs.sig-resource-group }} -GalleryName ${{ inputs.sig-name }} -GalleryImageDefinitionName ${{ inputs.image-def-name }} | 
          Sort-Object -Property PublishingProfile.PublishedDate -Descending | 
          Select-Object -First 1).Id
          
        if (-not $imageId) {
          Write-Host "Could not find image in gallery. Validation failed."
          exit 1
        }
        
        Write-Host "Found image ID: $imageId"
        
        # Generate a random password for the VM
        $adminPassword = [System.Guid]::NewGuid().ToString() + "aA1!"
        $adminPasswordSecure = ConvertTo-SecureString $adminPassword -AsPlainText -Force
        
        # Deploy validation VM
        $vmParams = @{
          ResourceGroupName = ${{ inputs.validation-rg }}
          Name = ${{ inputs.validation-vm-name }}
          Location = ${{ inputs.primary-region }}
          ImageId = $imageId
          Credential = New-Object System.Management.Automation.PSCredential ("azureuser", $adminPasswordSecure)
          Size = "Standard_D2s_v3"
          SecurityType = "Standard"
          PublicIpAddressName = "$(${{ inputs.validation-vm-name }})-pip"
          OpenPorts = 3389
        }
        
        Write-Host "Deploying validation VM..."
        $vm = New-AzVM @vmParams
        
        Write-Host "VM deployment completed. Waiting for VM to be ready..."
        # Wait for VM to be ready
        Start-Sleep -Seconds 60
        
        # Check VM status
        $vmStatus = (Get-AzVM -ResourceGroupName ${{ inputs.validation-rg }} -Name ${{ inputs.validation-vm-name }} -Status).Statuses | 
          Where-Object { $_.Code -like "PowerState/*" } | 
          Select-Object -ExpandProperty DisplayStatus
          
        Write-Host "VM Status: $vmStatus"
        
        if ($vmStatus -ne "VM running") {
          Write-Host "VM is not running. Validation failed."
          exit 1
        }
        
        Write-Host "Validation VM deployed and running successfully!"
    
    # ── Run basic validation tests on VM ───────────────────────
    - name: Run validation tests
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        
        # We'll use a simple test to verify the VM is responsive
        $vmStatus = Get-AzVM -ResourceGroupName ${{ inputs.validation-rg }} -Name ${{ inputs.validation-vm-name }} -Status
        $bootStatus = $vmStatus.Statuses | Where-Object { $_.Code -eq "OSState/generalized" -or $_.Code -eq "OSState/specialized" }
        
        if ($bootStatus.DisplayStatus -eq "OS state is specialized") {
          Write-Host "✅ VM is properly specialized (not generalized)"
        } else {
          Write-Host "❌ VM is not in the expected state. Found: $($bootStatus.DisplayStatus)"
          exit 1
        }
        
        Write-Host "✅ Validation tests passed!"
        
        # Add to summary
        Write-Output "### Validation Results" | Out-File -Append $env:GITHUB_STEP_SUMMARY
        Write-Output "* Validation VM: **${{ inputs.validation-vm-name }}**" | Out-File -Append $env:GITHUB_STEP_SUMMARY
        Write-Output "* VM Status: **Running**" | Out-File -Append $env:GITHUB_STEP_SUMMARY
        Write-Output "* Validation Result: **✅ Success**" | Out-File -Append $env:GITHUB_STEP_SUMMARY

    # ── Cleanup resources ─────────────────────────────────────
    - name: Cleanup resources
      if: always()
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Continue' # Don't exit on error during cleanup
        
        Write-Host "Cleaning up resources..."
        
        # Delete validation VM and resource group
        Write-Host "Deleting validation resource group: ${{ inputs.validation-rg }}"
        Remove-AzResourceGroup -Name ${{ inputs.validation-rg }} -Force -AsJob
        
        # Delete the image template
        Write-Host "Deleting image template: ${{ inputs.image-template-name }}"
        Remove-AzResource `
          -ResourceGroupName ${{ inputs.sig-resource-group }} `
          -ResourceType "Microsoft.VirtualMachineImages/imageTemplates" `
          -Name ${{ inputs.image-template-name }} `
          -Force
