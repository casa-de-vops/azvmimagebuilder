# .github/workflows/template.yaml
name: "[Template] Build and distribute custom VM image"

description: |
  Reusable workflow that builds and distributes a custom VM image with
  Azure Image Builder (AIB) and publishes the resolved template as an
  artifact.

on:
  workflow_call:
    inputs:
      templateFolder: { required: true, type: string }
      templateName: { required: true, type: string }
      sigResourceGroup: { required: true, type: string }
      imageDefName: { required: true, type: string }
      sigName: { required: true, type: string }
      uaiIdentityName: { required: true, type: string }
      location: { required: true, type: string }
      additionalregion: { required: false, type: string, default: '' }
      runOutputName: { required: true, type: string }
      buildRGName: { required: false, type: string }
      templateType:
        description: "armTemplate | imageTemplate. Allowed values: 'armTemplate', 'imageTemplate'."
        type: string
        required: true

    secrets:
      AZURE_CLIENT_ID: { required: true }
      AZURE_TENANT_ID: { required: true }
      AZURE_SUBSCRIPTION_ID: { required: true }

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write
  actions: read
  security-events: write

jobs:
  PREPARE-IMAGE-TEMPLATE:
    runs-on: "windows-latest"

    env:
      SUB_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      SIG_RG: ${{ inputs.sigResourceGroup }}
      TEMPLATE_FILE: ${{ inputs.templateName }}
      TEMPLATE_DIR: templates/${{ inputs.templateFolder }}
      TEMPLATE_TYPE: ${{ inputs.templateType }}
      IMAGE_DEF: ${{ inputs.imageDefName }}
      SIG_NAME: ${{ inputs.sigName }}
      PRIMARY_REGION: ${{ inputs.location }}
      ADDL_REGION: ${{ inputs.additionalregion }}
      RUN_OUTPUT: ${{ inputs.runOutputName }}
      BUILD_RG: "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ inputs.buildRGName }}"
      IMG_BUILDER_ID: "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ inputs.sigResourceGroup }}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${{ inputs.uaiIdentityName }}"

    outputs:
      release_version: ${{ steps.set_version.outputs.release_version }}
      image_template_name: ${{ steps.set_version.outputs.image_template_name }}

    steps:
      # ─────────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: true

      # ── Version = run‑number‑shortSHA ───────────────────────────
      - name: Set version
        id: set_version
        shell: bash
        run: |
          set -euo pipefail
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          VERSION="${GITHUB_RUN_NUMBER}-${SHORT_SHA}"
          echo "release_version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "image_template_name=${{ inputs.runOutputName }}-${VERSION}" >> "$GITHUB_OUTPUT"

      # ── Resolve template tokens ─────────────────────────────────
      - name: Resolve image template parameters
        shell: bash
        run: |
          set -euo pipefail
          cp "$TEMPLATE_DIR/$TEMPLATE_FILE" "$TEMPLATE_FILE"

          sed -i -e "s|<subscriptionID>|$SUB_ID|g"        "$TEMPLATE_FILE"
          sed -i -e "s|<rgName>|$SIG_RG|g"                "$TEMPLATE_FILE"
          sed -i -e "s|<imageDefName>|$IMAGE_DEF|g"       "$TEMPLATE_FILE"
          sed -i -e "s|<sharedImageGalName>|$SIG_NAME|g"  "$TEMPLATE_FILE"
          sed -i -e "s|<region1>|$PRIMARY_REGION|g"       "$TEMPLATE_FILE"
          sed -i -e "s|<region2>|$ADDL_REGION|g"          "$TEMPLATE_FILE"
          sed -i -e "s|<runOutputName>|$RUN_OUTPUT|g"     "$TEMPLATE_FILE"
          sed -i -e "s|<buildRGName>|$BUILD_RG|g"         "$TEMPLATE_FILE"
          sed -i -e "s%<imgBuilderId>%$IMG_BUILDER_ID%g" "$TEMPLATE_FILE"

      - name: Upload resolved template
        uses: actions/upload-artifact@v4
        with:
          name: resolved-image-template
          path: ${{ env.TEMPLATE_FILE }}

      # ── Submit Image Template ────────────────────────────────────────
      - name: Submit Image Template
        if: github.ref == 'refs/heads/main'
        id: submit_template
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_TEMPLATE_NAME="${{ steps.set_version.outputs.image_template_name }}"
          
          if [[ "${{ inputs.templateType }}" == "imageTemplate" ]]; then
            az resource create \
              --resource-group $SIG_RG \
              --properties @"${{ inputs.templateName }}" \
              --is-full-object \
              --resource-type Microsoft.VirtualMachineImages/imageTemplates \
              -n "$IMAGE_TEMPLATE_NAME"
              elif [[ "${{ inputs.templateType }}" == "armTemplate" ]]; then
            # Use PowerShell to deploy ARM template
            pwsh -Command "
              \$ErrorActionPreference = 'Stop'
              \$templateParams = @{
                imageTemplateName = '$IMAGE_TEMPLATE_NAME'
                svclocation       = '$PRIMARY_REGION'
                'api-version'     = '2022-07-01'
              }
              New-AzResourceGroupDeployment \
                -ResourceGroupName  '$SIG_RG' \
                -TemplateFile       '$TEMPLATE_FILE' \
                -Name               'it-$IMAGE_TEMPLATE_NAME' \
                -TemplateParameterObject \$templateParams
            "
              else
            echo "Invalid template type specified"
            exit 1
              fi
              echo "Template submitted successfully"

  BUILD-DISTRIBUTE-IMAGE:
    needs: PREPARE-IMAGE-TEMPLATE
    runs-on: "windows-latest"
    if: github.ref == 'refs/heads/main'
    
    env:
      SIG_RG: ${{ inputs.sigResourceGroup }}
      TEMPLATE_TYPE: ${{ inputs.templateType }}
      IMAGE_TEMPLATE_NAME: ${{ needs.PREPARE-IMAGE-TEMPLATE.outputs.image_template_name }}

    steps:
      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: true

      # ── Run Image Build ────────────────────────────────────────
      - name: Build Image (Image Template)
        if: inputs.templateType == 'imageTemplate'
        shell: bash
        run: |
          set -euo pipefail
          
          az resource invoke-action \
            --resource-group $SIG_RG \
            --resource-type Microsoft.VirtualMachineImages/imageTemplates \
            -n "$IMAGE_TEMPLATE_NAME" \
            --action Run
          
          echo "Image build started. This may take 30+ minutes to complete."

      - name: Build Image (ARM Template)
        if: inputs.templateType == 'armTemplate'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          # Invoke build
          Invoke-AzResourceAction `
            -ResourceGroupName $env:SIG_RG `
            -Name              $env:IMAGE_TEMPLATE_NAME `
            -ResourceType      'Microsoft.VirtualMachineImages/imageTemplates' `
            -Action            Run `
            -ApiVersion        '2022-07-01' `
            -Force

          # Poll every minute (30 min max)
          for ($i = 0; $i -lt 30; $i++) {
            Start-Sleep 60
            $res = Get-AzResource `
              -ResourceGroupName $env:SIG_RG `
              -ResourceType      'Microsoft.VirtualMachineImages/imageTemplates' `
              -Name              $env:IMAGE_TEMPLATE_NAME
            $status = $res.Properties.lastRunStatus
            Write-Host ("{0} → {1}" -f $status.runState, $status.runSubState)
            if ($status.runState -eq 'Succeeded') { break }
            if ($status.runState -eq 'Failed')    { throw "Image build failed" }
            if ($status.runState -eq 'Canceled')  { throw "Image build canceled" }
          }

      # ── Run summary ─────────────────────────────────────────────
      - name: Post run summary
        if: always()
        shell: bash
        run: |
          echo "### Azure Image Builder output" >> "$GITHUB_STEP_SUMMARY"
          echo "*${{ inputs.templateType }}:* **${{ needs.PREPARE-IMAGE-TEMPLATE.outputs.image_template_name }}**" >> "$GITHUB_STEP_SUMMARY"

  VALIDATE-AND-CLEANUP:
    needs: [PREPARE-IMAGE-TEMPLATE, BUILD-DISTRIBUTE-IMAGE]
    runs-on: "windows-latest"
    if: github.ref == 'refs/heads/main' && success()
    
    env:
      SIG_RG: ${{ inputs.sigResourceGroup }}
      TEMPLATE_TYPE: ${{ inputs.templateType }}
      IMAGE_TEMPLATE_NAME: ${{ needs.PREPARE-IMAGE-TEMPLATE.outputs.image_template_name }}
      PRIMARY_REGION: ${{ inputs.location }}
      SUB_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      SIG_NAME: ${{ inputs.sigName }}
      IMAGE_DEF: ${{ inputs.imageDefName }}
      VALIDATION_VM_NAME: "vm-validate-${{ needs.PREPARE-IMAGE-TEMPLATE.outputs.release_version }}"
      VALIDATION_RG: "rg-img-validation-${{ needs.PREPARE-IMAGE-TEMPLATE.outputs.release_version }}"

    steps:
      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: true

      # ── Wait for image distribution to complete ──────────────────
      - name: Wait for image distribution to complete
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "Waiting for image distribution to complete..."

          # Wait for the image distribution to finish (checking template status)
          $maxRetries = 60  # 30 minutes (checking every 30 seconds)
          $retryCount = 0
          $success = $false

          do {
            $retryCount++
            $res = Get-AzResource `
              -ResourceGroupName $env:SIG_RG `
              -ResourceType 'Microsoft.VirtualMachineImages/imageTemplates' `
              -Name $env:IMAGE_TEMPLATE_NAME `
              -ErrorAction SilentlyContinue
            
            if ($res -and $res.Properties.lastRunStatus) {
              $status = $res.Properties.lastRunStatus
              Write-Host "[$retryCount/$maxRetries] Image status: $($status.runState) → $($status.runSubState)"
              
              if ($status.runState -eq 'Succeeded') {
                $success = $true
                break
              }
              elseif ($status.runState -eq 'Failed' -or $status.runState -eq 'Canceled') {
                Write-Host "Image creation failed with status: $($status.runState)"
                Write-Host "Error: $($status.message)"
                exit 1
              }
            }
            else {
              Write-Host "[$retryCount/$maxRetries] Waiting for image template status..."
            }
            
            Start-Sleep -Seconds 30
          } while ($retryCount -lt $maxRetries)

          if (-not $success) {
            Write-Host "Timed out waiting for image distribution to complete!"
            exit 1
          }

          Write-Host "Image distribution completed successfully!"

      # ── Create resource group for validation VM ─────────────────
      - name: Create validation resource group
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-AzResourceGroup -Name $env:VALIDATION_RG -Location $env:PRIMARY_REGION -Force
          Write-Host "Created validation resource group: $env:VALIDATION_RG"

      # ── Deploy validation VM using the new image ────────────────
      - name: Deploy validation VM
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          
          # Get the latest image version
          $imageId = (Get-AzGalleryImageVersion -ResourceGroupName $env:SIG_RG -GalleryName $env:SIG_NAME -GalleryImageDefinitionName $env:IMAGE_DEF | 
            Sort-Object -Property PublishingProfile.PublishedDate -Descending | 
            Select-Object -First 1).Id
            
          if (-not $imageId) {
            Write-Host "Could not find image in gallery. Validation failed."
            exit 1
          }
          
          Write-Host "Found image ID: $imageId"
          
          # Generate a random password for the VM
          $adminPassword = [System.Guid]::NewGuid().ToString() + "aA1!"
          $adminPasswordSecure = ConvertTo-SecureString $adminPassword -AsPlainText -Force
          
          # Deploy validation VM
          $vmParams = @{
            ResourceGroupName = $env:VALIDATION_RG
            Name = $env:VALIDATION_VM_NAME
            Location = $env:PRIMARY_REGION
            ImageId = $imageId
            Credential = New-Object System.Management.Automation.PSCredential ("azureuser", $adminPasswordSecure)
            Size = "Standard_D2s_v3"
            SecurityType = "Standard"
            PublicIpAddressName = "$($env:VALIDATION_VM_NAME)-pip"
            OpenPorts = 3389
          }
          
          Write-Host "Deploying validation VM..."
          $vm = New-AzVM @vmParams
          
          Write-Host "VM deployment completed. Waiting for VM to be ready..."
          # Wait for VM to be ready
          Start-Sleep -Seconds 60
          
          # Check VM status
          $vmStatus = (Get-AzVM -ResourceGroupName $env:VALIDATION_RG -Name $env:VALIDATION_VM_NAME -Status).Statuses | 
            Where-Object { $_.Code -like "PowerState/*" } | 
            Select-Object -ExpandProperty DisplayStatus
            
          Write-Host "VM Status: $vmStatus"
          
          if ($vmStatus -ne "VM running") {
            Write-Host "VM is not running. Validation failed."
            exit 1
          }
          
          Write-Host "Validation VM deployed and running successfully!"
      
      # ── Run basic validation tests on VM ───────────────────────
      - name: Run validation tests
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          
          # We'll use a simple test to verify the VM is responsive
          $vmStatus = Get-AzVM -ResourceGroupName $env:VALIDATION_RG -Name $env:VALIDATION_VM_NAME -Status
          $bootStatus = $vmStatus.Statuses | Where-Object { $_.Code -eq "OSState/generalized" -or $_.Code -eq "OSState/specialized" }
          
          if ($bootStatus.DisplayStatus -eq "OS state is specialized") {
            Write-Host "✅ VM is properly specialized (not generalized)"
          } else {
            Write-Host "❌ VM is not in the expected state. Found: $($bootStatus.DisplayStatus)"
            exit 1
          }
          
          Write-Host "✅ Validation tests passed!"
          
          # Add to summary
          Write-Output "### Validation Results" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          Write-Output "* Validation VM: **$env:VALIDATION_VM_NAME**" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          Write-Output "* VM Status: **Running**" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          Write-Output "* Validation Result: **✅ Success**" | Out-File -Append $env:GITHUB_STEP_SUMMARY

      # ── Cleanup resources ─────────────────────────────────────
      - name: Cleanup resources
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue' # Don't exit on error during cleanup
          
          Write-Host "Cleaning up resources..."
          
          # Delete validation VM and resource group
          Write-Host "Deleting validation resource group: $env:VALIDATION_RG"
          Remove-AzResourceGroup -Name $env:VALIDATION_RG -Force -AsJob
          
          # Delete the image template
          Write-Host "Deleting image template: $env:IMAGE_TEMPLATE_NAME"
          Remove-AzResource `
            -ResourceGroupName $env:SIG_RG `
            -ResourceType "Microsoft.VirtualMachineImages/imageTemplates" `
            -Name $env:IMAGE_TEMPLATE_NAME `
            -Force
